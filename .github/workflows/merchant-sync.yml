name: Merchant Sync Job

on:
  # Run daily at 2 AM UTC
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      merchant:
        description: 'Specific merchant to sync (leave empty for all)'
        required: false
        default: ''
      force:
        description: 'Force full sync (skip incremental check)'
        required: false
        default: 'false'
        type: boolean

  # Run on push to main (for testing)
  push:
    branches: [main]
    paths:
      - 'buildstock-pro/backend/src/services/sync.service.ts'
      - 'buildstock-pro/backend/src/jobs/**'
      - '.github/workflows/merchant-sync.yml'

env:
  BUN_VERSION: 'latest'
  NODE_VERSION: '20'

jobs:
  merchant-sync:
    name: Sync Merchant Products
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install backend dependencies
        run: bun install
        working-directory: ./buildstock-pro/backend

      - name: Create environment file
        run: |
          touch .env
          echo SUPABASE_URL=${{ secrets.SUPABASE_URL }} >> .env
          echo SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }} >> .env
          echo SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} >> .env
          echo DATABASE_URL=${{ secrets.DATABASE_URL }} >> .env
          echo JWT_SECRET=${{ secrets.JWT_SECRET }} >> .env
          echo SYNC_API_KEY=${{ secrets.SYNC_API_KEY }} >> .env
          echo SCREWFIX_API_KEY=${{ secrets.SCREWFIX_API_KEY }} >> .env
          echo WICKES_API_KEY=${{ secrets.WICKES_API_KEY }} >> .env
          echo BANDQ_API_KEY=${{ secrets.BANDQ_API_KEY }} >> .env
          echo JEWSON_API_KEY=${{ secrets.JEWSON_API_KEY }} >> .env
          echo NODE_ENV=production >> .env
        working-directory: ./buildstock-pro/backend

      - name: Run merchant sync
        id: sync
        run: |
          # Set merchant filter if provided
          MERCHANT_FLAG=""
          if [ -n "${{ github.event.inputs.merchant }}" ]; then
            MERCHANT_FLAG="--merchant ${{ github.event.inputs.merchant }}"
          fi

          # Set force flag if provided
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" = "true" ]; then
            FORCE_FLAG="--force"
          fi

          # Run the sync script
          echo "Starting merchant sync..."
          bun run src/scripts/sync-merchants.ts $MERCHANT_FLAG $FORCE_FLAG || true

          echo "sync_completed=true" >> $GITHUB_OUTPUT
        working-directory: ./buildstock-pro/backend

      - name: Check sync results
        run: |
          echo "Checking sync results..."
          # Query Supabase for sync status
          # This would be a custom script to check the sync_logs table

      - name: Create sync report
        if: always()
        run: |
          echo "## Merchant Sync Report" > sync-report.md
          echo "**Date:** $(date -u)" >> sync-report.md
          echo "**Status:** ${{ job.status }}" >> sync-report.md
          echo "**Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> sync-report.md
          cat sync-report.md

      - name: Upload sync report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-report-${{ github.run_number }}
          path: sync-report.md
          retention-days: 30

      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "❌ Merchant Sync Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Merchant Sync Failed*\n*Repository:* ${{ github.repository }}\n*Run:* ${{ github.run_number }}\n*Triggered by:* ${{ github.actor }}\n*Merchant:* ${{ github.event.inputs.merchant || 'All Merchants' }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      - name: Notify on success
        if: success()
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "text": "✅ Merchant Sync Completed Successfully",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Merchant Sync Completed*\n*Repository:* ${{ github.repository }}\n*Run:* ${{ github.run_number }}\n*Triggered by:* ${{ github.event_name }}\n*Merchant:* ${{ github.event.inputs.merchant || 'All Merchants' }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

  # ============================================
  # SYNC HEALTH CHECK
  # ============================================
  sync-health-check:
    name: Verify Sync Health
    runs-on: ubuntu-latest
    needs: merchant-sync
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install axios
        working-directory: ./buildstock-pro

      - name: Check sync status via API
        run: |
          node -e "
          const axios = require('axios');
          const backendUrl = '${{ secrets.BACKEND_URL }}';
          const apiKey = '${{ secrets.SYNC_API_KEY }}';

          axios.get(backendUrl + '/api/v1/sync/status', {
            headers: { 'Authorization': 'Bearer ' + apiKey }
          })
          .then(response => {
            console.log('✓ Sync status endpoint is responding');
            console.log('Last sync:', response.data.lastSync);
            console.log('Total products:', response.data.totalProducts);
          })
          .catch(err => {
            console.error('✗ Sync status check failed:', err.message);
            process.exit(1);
          });
          "

      - name: Verify product database
        run: |
          echo "Checking product database health..."
          # This would query Supabase to ensure products were updated
          echo "Product database verification would go here"
